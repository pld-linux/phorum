--- phorum/common.php	2010-01-12 19:23:19.129687819 +0200
+++ phorum/common.php	2010-01-12 19:36:17.512942870 +0200
@@ -20,6 +20,8 @@
 // Check that this file is not loaded directly.
 if ( basename( __FILE__ ) == basename( $_SERVER["PHP_SELF"] ) ) exit();
 
+define('PHORUM_DIR', dirname(__FILE__));
+define('PHORUM_INCLUDES_DIR', PHORUM_DIR.'/include');
 
 // ----------------------------------------------------------------------
 // Initialize variables and constants and load required libraries
@@ -82,22 +84,22 @@
     ob_start();
 
     // Load configuration.
-    if (! include_once( "./include/db/config.php" )) {
+    if (! include_once( "/etc/webapps/phorum/config.php" )) {
         print '<html><head><title>Phorum error</title></head><body>';
         print '<h2>Phorum database configuration error</h2>';
 
         // No database configuration found.
-        if (!file_exists("./include/db/config.php")) { ?>
+        if (!file_exists("/etc/webapps/phorum/config.php")) { ?>
             Phorum has been installed on this server, but the configuration<br/>
             for the database connection has not yet been made. Please read<br/>
             <a href="docs/install.txt">docs/install.txt</a> for installation
             instructions. <?php
         } else {
-            $fp = fopen("./include/db/config.php", "r");
+            $fp = fopen("/etc/webapps/phorum/config.php", "r");
             // Unable to read the configuration file.
             if (!$fp) { ?>
                 A database configuration file was found in
-                ./include/db/config.php,<br/>but Phorum was unable to read it.
+                config.php,<br/>but Phorum was unable to read it.
                 Please check the file permissions<br/>for this file. <?php
             // Unknown error.
             } else {
@@ -134,7 +136,7 @@
 
 // Load the database layer.
 $PHORUM['DBCONFIG']['type'] = basename($PHORUM['DBCONFIG']['type']);
-require_once( "./include/db/{$PHORUM['DBCONFIG']['type']}.php" );
+require_once PHORUM_INCLUDES_DIR."/db/{$PHORUM['DBCONFIG']['type']}.php";
 
 // Try to setup a connection to the database.
 if(!phorum_db_check_connection()){
@@ -217,7 +219,7 @@
 // Load the caching-layer. You can specify a different one in the settings.
 // One caching layer *needs* to be loaded.
 $PHORUM['cache_layer'] = basename($PHORUM['cache_layer']);
-require_once PHORUM_INCLUDES_DIR.'/cache/$PHORUM[cache_layer].php';
+require_once PHORUM_INCLUDES_DIR.'/cache/'.$PHORUM['cache_layer'].'.php';
 
 // Load phorum_get_url().
 // This function is used for generating all Phorum URLs.
@@ -227,7 +229,7 @@
 // module authors a chance to override them. This can be especially useful
 // for distibuting a module that contains a full Phorum template as well.
 // For switching, the function phorum_switch_template() can be used.
-$PHORUM['template_path'] = './templates';
+$PHORUM['template_path'] = PHORUM_DIR.'/templates';
 $PHORUM['template_http_path'] = $PHORUM['http_path'].'/templates';
 
 // ----------------------------------------------------------------------
@@ -691,9 +693,9 @@
 
     }
 
-    if ( !isset( $PHORUM["language"] ) || empty( $PHORUM["language"] ) || !file_exists( "./include/lang/$PHORUM[language].php" ) )
+    if (!isset($PHORUM["language"]) || empty($PHORUM["language"]) || !file_exists(PHORUM_INCLUDES_DIR."/lang/$PHORUM[language].php"))
         $PHORUM["language"] = $PHORUM["default_forum_options"]["language"];
-    if ( !file_exists("./include/lang/$PHORUM[language].php") ) {
+    if ( !file_exists(PHORUM_INCLUDES_DIR."/lang/{$PHORUM['language']}.php") ) {
         $PHORUM["language"] = PHORUM_DEFAULT_LANGUAGE;
     }
 
@@ -714,8 +716,8 @@
     }
 
     $PHORUM['language'] = basename($PHORUM['language']);
-    if ( file_exists( "./include/lang/$PHORUM[language].php" ) ) {
-        require_once PHORUM_INCLUDES_DIR.'/lang/$PHORUM[language].php';
+    if ( file_exists( PHORUM_INCLUDES_DIR."/lang/{$PHORUM['language']}.php" ) ) {
+        require_once PHORUM_INCLUDES_DIR."/lang/{$PHORUM['language']}.php";
     }
     // load languages for localized modules
     if ( isset( $PHORUM["hooks"]["lang"] ) && is_array($PHORUM["hooks"]["lang"]) ) {
@@ -723,11 +725,11 @@
         {
             // load mods for this hook
             $mod = basename($mod);
-            if ( file_exists( "./mods/$mod/lang/$PHORUM[language].php" ) ) {
-                require_once "./mods/$mod/lang/$PHORUM[language].php";
+            if ( file_exists(PHORUM_DIR."/mods/$mod/lang/$PHORUM[language].php" ) ) {
+                require_once PHORUM_DIR."/mods/$mod/lang/$PHORUM[language].php";
             }
-            elseif ( file_exists( "./mods/$mod/lang/".PHORUM_DEFAULT_LANGUAGE.".php" ) ) {
-                require_once "./mods/$mod/lang/".PHORUM_DEFAULT_LANGUAGE.".php";
+            elseif ( file_exists(PHORUM_DIR."/mods/$mod/lang/".PHORUM_DEFAULT_LANGUAGE.".php" ) ) {
+                require_once PHORUM_DIR."/mods/$mod/lang/".PHORUM_DEFAULT_LANGUAGE.".php";
             }
         }
     }
@@ -998,8 +1000,8 @@
     // strings at some point after all, for example if we reset the
     // author name in messages for deleted users to "anonymous".
     $PHORUM["language"] = basename($PHORUM["default_forum_options"]["language"]);
-    if (file_exists("./include/lang/$PHORUM[language].php")) {
-        require_once PHORUM_INCLUDES_DIR.'/lang/$PHORUM[language].php';
+    if (file_exists(PHORUM_INCLUDES_DIR."/lang/{$PHORUM['language']}.php")) {
+        require_once PHORUM_INCLUDES_DIR."/lang/{$PHORUM['language']}.php";
     }
 }
 
@@ -1308,7 +1310,7 @@
             // could be an incomplete or empty template.
             $postfix = '/info.php';
         } else {
-            $prefix = './mods/'.basename($module).'/templates';
+            $prefix = PHORUM_DIR.'/mods/'.basename($module).'/templates';
             $postfix = '';
         }
 
@@ -1669,10 +1671,10 @@
         foreach( $PHORUM["hooks"][$hook]["mods"] as $mod ) {
             // load mods for this hook
             $mod = basename($mod);
-            if ( file_exists( "./mods/$mod/$mod.php" ) ) {
-                require_once "./mods/$mod/$mod.php";
-            } elseif ( file_exists( "./mods/$mod.php" ) ) {
-                require_once "./mods/$mod.php";
+            if ( file_exists( PHORUM_DIR."/mods/$mod/$mod.php" ) ) {
+                require_once PHORUM_DIR."/mods/$mod/$mod.php";
+            } elseif ( file_exists( PHORUM_DIR."/mods/$mod.php" ) ) {
+                require_once PHORUM_DIR."/mods/$mod.php";
             }
         }
 
@@ -1759,10 +1761,10 @@
 
     $langs = array();
 
-    $d = dir( "./include/lang" );
+    $d = dir(PHORUM_INCLUDES_DIR."/lang" );
     while ( false !== ( $entry = $d->read() ) ) {
-        if ( substr( $entry, -4 ) == ".php" && is_file( "./include/lang/$entry" ) ) {
-            @include "./include/lang/$entry";
+        if ( substr( $entry, -4 ) == ".php" && is_file(PHORUM_INCLUDES_DIR."/lang/$entry" ) ) {
+            include PHORUM_INCLUDES_DIR."/lang/$entry";
             if ( !isset( $language_hide ) || empty( $language_hide ) || defined( "PHORUM_ADMIN" ) ) {
                 $langs[str_replace( ".php", "", $entry )] = $language;
             } else {
--- phorum-5.2.14/include/admin/install.php~	2010-01-06 19:23:20.000000000 +0200
+++ phorum-5.2.14/include/admin/install.php	2010-01-06 19:23:35.421527751 +0200
@@ -25,7 +25,7 @@
 include_once("./include/api/user.php");
 
 if(!phorum_db_check_connection()){
-    echo "A database connection could not be established.  Please edit include/db/config.php.";
+    echo "A database connection could not be established.  Please edit config.php.";
     return;
 }
 
--- phorum/include/admin/header.php~	2009-07-22 14:58:57.000000000 +0300
+++ phorum/include/admin/header.php	2010-01-06 20:02:05.938378394 +0200
@@ -36,7 +36,7 @@
 
     // set the path to the CSS file to pull in
     $default_admin_css_file = 'default.css';
-    $admin_css_path = $PHORUM["http_path"].'/include/admin/css/' . $default_admin_css_file;
+    $admin_css_path = $PHORUM["http_path"].'/admin/css/' . $default_admin_css_file;
 
     /**
      * [hook]
--- phorum/htdocs/admin/css/default.css~	2010-01-06 20:13:13.000000000 +0200
+++ phorum/htdocs/admin/css/default.css	2010-01-06 20:13:19.085201493 +0200
@@ -118,19 +118,19 @@
 .icon-folder-up {
     width: 22px;
     padding-left: 22px;
-    background: url(../../../images/folder_up.png) 0 1px no-repeat;
+    background: url(../../images/folder_up.png) 0 1px no-repeat;
 }
 
 .icon-folder {
     width: 22px;
     padding-left: 22px;
-    background: url(../../../images/folder.png) 0 1px no-repeat;
+    background: url(../../images/folder.png) 0 1px no-repeat;
 }
 
 .icon-forum {
     width: 22px;
     padding-left: 22px;
-    background: url(../../../images/forum.png) 0 1px no-repeat;
+    background: url(../../images/forum.png) 0 1px no-repeat;
 }
 
 .PhorumAdminTableHead
@@ -154,7 +154,7 @@
 
 .PhorumAdminError
 {
-    background-image: url("../../../images/alert.gif");
+    background-image: url("../../images/alert.gif");
     background-position: 5px 5px;
     background-repeat: no-repeat;
     font-family: Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica;
--- phorum-5.2.14/include/admin/cache.php~	2010-01-11 16:30:31.000000000 +0200
+++ phorum-5.2.14/include/admin/cache.php	2010-01-11 16:58:45.262528168 +0200
@@ -32,7 +32,7 @@
             case "cache":
 
                 if ( empty( $value ) ) {
-                    $new_settings[$field] = "/tmp";
+                    $new_settings[$field] = "/var/cache/phorum";
                 } elseif ( !file_exists( $value ) ) {
                     $error = "This cache directory does not exist.  Please create it with the proper permissions.";
                 } else {
--- phorum/include/db/mysql.php~	2010-01-12 18:38:55.000000000 +0200
+++ phorum/include/db/mysql.php	2010-01-12 18:42:08.086600820 +0200
@@ -7636,7 +7636,7 @@
 );
 
 // Load the specific code for the PHP extension that we use.
-$extfile = "./include/db/mysql/{$ext}.php";
+$extfile = PHORUM_INCLUDES_DIR."/db/mysql/{$ext}.php";
 if (!file_exists($extfile)) trigger_error(
    "The Phorum MySQL database layer is unable to find the extension " .
    "file $extfile on the system. Check if all Phorum files are uploaded " .
--- phorum-5.2.14/htdocs/ajax.php~	2010-01-12 19:06:49.000000000 +0200
+++ phorum-5.2.14/htdocs/ajax.php	2010-01-12 19:07:09.826450999 +0200
@@ -154,7 +154,7 @@
 }
 
 // Check if the Ajax call has a core handler script.
-if (file_exists("./include/ajax/call.$ajax_call.php")) {
+if (file_exists(PHORUM_INCLUDES_DIR."/ajax/call.$ajax_call.php")) {
     include PHORUM_INCLUDES_DIR.'/ajax/call.$ajax_call.php';
     exit();
 }
--- phorum/htdocs/javascript.php	2010-01-12 19:00:24.036492037 +0200
+++ phorum/htdocs/javascript.php	2010-01-12 19:02:34.413145270 +0200
@@ -31,15 +31,15 @@
 $module_registrations[] = array(
     'module'    => 'core',
     'source'    => 'file(include/ajax/client.js.php)',
-    'cache_key' => filemtime('./include/ajax/client.js.php') .
+    'cache_key' => filemtime(PHORUM_INCLUDES_DIR.'/ajax/client.js.php') .
                    $PHORUM['DATA']['URL']['AJAX']
 );
 
 // Add template specific javascript code, if available. The template writer
 // can put the javascript code to include in the file
 // "templates/<name>/javascript.tpl" or "templates/<name>/javascript.php".
-if (file_exists("./templates/{$PHORUM['template']}/javascript.tpl") ||
-    file_exists("./templates/{$PHORUM['template']}/javascript.php")) {
+if (file_exists(PHORUM_DIR."/templates/{$PHORUM['template']}/javascript.tpl") ||
+    file_exists(PHORUM_DIR."/templates/{$PHORUM['template']}/javascript.php")) {
     $module_registrations[] = array(
         'module' => $PHORUM['template'] . ' template',
         'source' => 'template(javascript)'
@@ -234,10 +234,10 @@
         {
             case "file":
                 ob_start();
-                // Make sure that relative paths start with "./",
-                // just in case "." is not in the PHP include path.
+                // Make relative paths start with PHORUM_DIR,
+                // as we moved files around.
                 $path = $r['source'][0] == '/'
-                      ? $r['source'] : './'.$r['source'];
+                      ? $r['source'] : PHORUM_DIR.'/'.$r['source'];
                 include($path);
                 $content .= ob_get_contents();
                 ob_end_clean();
--- phorum/htdocs/css.php~	2010-01-12 19:27:06.000000000 +0200
+++ phorum/htdocs/css.php	2010-01-12 19:30:47.253394705 +0200
@@ -274,7 +274,11 @@
         {
             case "file":
                 ob_start();
-                include($r['source']);
+                // Make relative paths start with PHORUM_DIR,
+                // as we moved files around.
+                $path = $r['source'][0] == '/'
+                     ? $r['source'] : PHORUM_DIR.'/'.$r['source'];
+                include($path);
                 $add .= ob_get_contents();
                 ob_end_clean();
                 break;
--- phorum/include/admin/header.php~	2010-01-13 19:03:16.000000000 +0200
+++ phorum/include/admin/header.php	2010-01-13 21:30:22.607156616 +0200
@@ -25,7 +25,7 @@
         if (!file_exists("./include/lang/${lang}.php")) {
             $lang = PHORUM_DEFAULT_LANGUAGE;
         }
-        require_once PHORUM_INCLUDES_DIR.'/lang/{$lang}.php';
+        require_once PHORUM_INCLUDES_DIR."/lang/{$lang}.php";
     }
 
     // HTTP Content-Type header with the charset from the default language
--- phorum/htdocs/admin.php	2010-01-13 21:31:15.510488551 +0200
+++ phorum/htdocs/admin.php	2010-01-13 21:33:38.367557450 +0200
@@ -77,7 +77,7 @@
             } elseif(isset($_GET["module"]) && is_scalar($_GET["module"])){
                 $module = @basename($_GET["module"]);
             }
-            if(empty($module) || !file_exists("./include/admin/$module.php")){
+            if(empty($module) || !file_exists(PHORUM_INCLUDES_DIR."/admin/$module.php")){
                 $module = "default";
             }
             // check the admin token
@@ -105,7 +105,7 @@
     $module = phorum_hook( "admin_pre", $module );
     ob_start();
     if($module!="help") require_once PHORUM_INCLUDES_DIR.'/admin/header.php';
-    require_once PHORUM_INCLUDES_DIR.'/admin/$module.php';
+    require_once PHORUM_INCLUDES_DIR."/admin/$module.php";
     if($module!="help") require_once PHORUM_INCLUDES_DIR.'/admin/footer.php';
     ob_end_flush();
 
--- phorum/include/api/modules.php~	2010-01-13 19:03:16.000000000 +0200
+++ phorum/include/api/modules.php	2010-01-13 21:36:05.906916979 +0200
@@ -95,10 +95,10 @@
 
     require_once PHORUM_INCLUDES_DIR.'/version_functions.php';
 
-    $dh = opendir("./mods");
+    $dh = opendir(PHORUM_DIR."/mods");
     if (! $dh) trigger_error(
         "Unable to create a list of available modules: " .
-        "opendir of directory \"./mods\" failed.",
+        "opendir of directory \"mods\" failed.",
         E_USER_ERROR
     );
 
@@ -116,11 +116,11 @@
 
         // Read in the module information.
         $lines = array();
-        if (file_exists("./mods/$entry/info.txt")) {
-            $lines = file("./mods/$entry/info.txt");
-        } elseif (is_file("./mods/$entry") && substr($entry, -4)==".php") {
+        if (file_exists(PHORUM_DIR."/mods/$entry/info.txt")) {
+            $lines = file(PHORUM_DIR."/mods/$entry/info.txt");
+        } elseif (is_file(PHORUM_DIR."/mods/$entry") && substr($entry, -4)==".php") {
             $entry = str_replace(".php", "", $entry);
-            $data = file_get_contents("./mods/$entry.php");
+            $data = file_get_contents(PHORUM_DIR."/mods/$entry.php");
             if($data = stristr($data, "/* phorum module info")){
                 $data = substr($data, 0, strpos($data, "*/"));
                 $lines = preg_split('!(\r|\n|\r\n)!', $data);
